# 任务目标
**计算机学院：评估简报**
**模块标题：区块链技术**
**模块代码：COMP5125M**
**作业标题：课程作业**
**作业类型和描述：**
这是一个编程作业，要求学生为拼车系统开发智能合约。
**理由：**
本作业的目的是评估学生对基于区块链的系统和智能合约开发技能的了解。
**字数限制和指导：不适用（N/A）**
**权重：30%**
**提交截止日期：2024年5月3日**
**提交方法：学生将通过Gradescope上传他们的作业**
**反馈提供：通过Gradescope在线提供反馈**
**评估的学习成果：**
设计去中心化应用程序和实现智能合约，理解分布式账本的应用背景
**模块负责人：Evangelos Pournaras**
**其他教职员工联系：Zhuolun Li**

**1 作业指导**
**背景：**
拼车，也称为共享汽车或共乘，涉及个人共享一辆汽车以同一方向或共同目的地旅行，而不是驾驶单独的汽车。拼车的主要目标是减少道路上的车辆数量，提供一种可持续的交通选择。它解决了交通拥堵、环境影响、燃油成本和能源保护等挑战，同时增加了人们之间的社交互动。基于区块链的拼车服务比传统的、集中式的拼车应用程序具有独特的优势。其主要好处是通过区块链技术透明和不可变的特性增强了用户之间的信任。此外，区块链还支持基于智能合约的自动支付结算，确保司机获得公平的报酬。这种方法不仅简化了支付过程，还减少了中介费用。总体而言，基于区块链的拼车系统提高了透明度、安全性和效率，与常规拼车应用程序相比，提供了一种更值得信赖且成本效益更高的解决方案。在本课程作业中，您需要为拼车系统开发一个Solidity智能合约。

**场景：**
本课程作业侧重于一个拼车系统，涉及两种类型的参与者：司机和乘客，下面描述了一个简化的场景：
- **乘车：**只有司机可以创建乘车。假定司机会诚实地参加并完成乘车。乘客可以查看可用的乘车并预订座位。假定乘客总是会参加他们预订的乘车，因此不考虑乘车取消。
- **地图：**系统在地图上运行，有三个独立的位置：A、B和C。车辆可以在这些点之间旅行（例如，A到B，B到C）。乘客只有在起点和目的地符合他们的旅行要求时才能预订乘车。
- **时间跟踪：**为简化起见，我们假设乘车是在旅行日期前一天创建的，这样就不需要跟踪天数。旅程开始时间应精确到小时，并应在智能合约中表示为从0到23的无符号整数，其中0代表00:00，1代表01:00，依此类推。
- **支付：**系统中使用的货币是以太币。乘客必须在预订乘车时提前支付座位费。由司机设定的座位价格在乘车被标记为完成时自动转移到司机账户。

**智能合约：**
您将获得一个在contract template.sol中的智能合约模板。该模板概述了您需要实现的结构和基本功能。这些功能的细节如下：

**基本功能：**
- **注册：**在使用任何其他功能之前，区块链地址必须在合约中注册为司机或乘客。例如，创建乘车的函数只能由注册司机使用，加入乘车的函数应验证调用者是否为注册乘客。
- **乘车创建和记录：**司机可以通过提供包括以下信息来创建乘车：
  - 旅行时间（旅程开始时间，表示为从0到23的无符号整数）
  - 乘车中可用的座位数
  - 座位价格
  - 乘车的起点
  - 乘车的目的地
  当乘车存储在智能合约中时，应记录以下额外信息：
  - 乘车的唯一ID（从0开始计数）
  - 司机的区块链地址
  - 乘车的状态（可能的状态是BookingOpen、FullyBooked、Started、Completed）
  - 已预订乘车的乘客的区块链地址
  该函数应包括必要的检查以确保乘车有效：旅行时间应为0到23之间的数字；起点和目的地应不同；座位价格应大于零；可用座位应大于零。
- **乘车查询：**乘客可以使用findRides函数找到合适的乘车。此函数返回所有与乘客的起点和目的地匹配且处于BookingOpen状态的乘车ID。然后，乘客可以使用模板中提供的getRideById函数查询乘车的详细信息。
- **乘车预订：**乘客使用joinRide函数预订乘车，该函数需要支付座位价格的押金。此函数相应地更新可用座位数和乘客地址。当所有座位都被预订时，它还会更新乘车状态为FullyBooked。
- **开始和完成乘车：**出发时，司机调用startRide函数将乘车状态更新为Started。完成乘车时，他们使用completeRide函数将乘车标记为Completed，这会触发将乘客的支付转移到司机账户。

**协调机制：**
在当前设置中，乘客通过手动选择最合适的选项并向合约发送预订请求来单独预订乘车。然而，有了关于所有可用乘车和所有潜在乘客偏好的信息，可以做出更有效的安排。例如，考虑一个场景，其中有两个可用的乘车从A点到B点，每个乘车只剩下一个座位。一个在8:00出发，另一个在14:00出发。两个乘客，Alice和Bob，希望从A点到B点旅行。Alice希望在6:00离开，Bob希望在10:00离开。如果他们分别预订，Bob很可能会先选择8:00的乘车，更接近他的首选时间。这使得Alice只能选择14:00的乘车，这与她的首选时间相差甚远。然而，通过协调，我们可以安排Bob乘坐14:00的乘车，Alice乘坐8:00的乘车。这个调整将使得总的偏离首选旅行时间更小。让我们将乘客的首选旅行时间表示为tpreferred，实际旅行时间表示为tactual。旅行时间偏差计算为|tpreferred − tactual|。总旅行时间偏差是所有乘客的旅行时间偏差之和。在上面的例子中，原始的总旅行时间偏差是|10 − 8| + |6 − 14| = 10。如果Alice和Bob同意协调，总旅行时间偏差是|10 − 14| + |6 − 8| = 6。协调机制的目标是以一种节省燃气的方式最小化总旅行时间偏差。重要的是在实现这一目标的同时，不能排除乘客的乘车分配。如果一个可用的乘车与乘客的起点和目的地匹配，他们必须被分配到那次乘车，无论旅行时间偏差如何。如果做不到这一点，将会导致非常低的分数。为了实现这一点，请在模板中完成两个函数：awaitAssignRide和assignPassengersToRides，详细如下：

- **awaitAssignRide：**选择协调的乘客使用此函数而不是joinRide。他们提供他们的起点和目的地、首选旅行时间以及他们愿意支付的价格。他们愿意支付的价格作为押金转移到合约。该函数确保押金到位后记录乘客的信息。为了简化，假设协调的乘客总是支付足够的押金，足以加入任何乘车（因此在分配乘车时不需要考虑这个因素）。这个函数不是立即分配乘车，而是在合约中记录乘客的信息，等待assignPassengersToRides函数的调用。
- **assignPassengersToRides：**此函数由系统执行，为使用awaitAssignRide的乘客分配乘车。它的目标是最小化乘客的首选和实际旅行时间之间的差异之和。您可以自由实现任何符合此目标的分配算法。记住，在给乘客分配乘车时，更新可用座位、乘客地址，并可能更新乘车状态，类似于joinRide函数。此外，如果分配的价格比乘客预付的价格便宜，差价应退还给乘客；如果乘客没有被分配到任何乘车，押金应全额退还。

您可以使用的数据结构或辅助函数没有任何限制，以实现协调机制。评分将基于（1）实现的正确性，例如一个乘客不能两次调用awaitAssignRide，assignPassengersToRides应该在可能的情况下分配乘客到乘车；（2）协调机制在减少总旅行时间偏差方面的有效性；以及（3）实现的燃气效率。

**2 任务和要求**
根据上述信息，您需要完成以下任务：
1. 完成在contract template.sol中提供的智能合约模板。您需要完成基本功能和协调机制。
   - 您允许（但不是必需）：根据您自己的要求添加辅助函数、结构、合约变量。例如，您的findRide函数可以调用您创建的另一个函数来检查乘车是否符合乘客的旅行要求。
   - 您不允许：更改或删除模板中声明的任何内容，包括结构体、函数名称、输入参数和返回值。外部库也是不允许的。未能这样做将使您的合约在测试中失败，导致零分。
2. 在markdown文件中完成简短的文档，使用在readme template.md中提供的模板。模板提供了文档中应包含的内容的说明。您需要：
   - 提供您提出的协调机制的简要描述。
   - 如果您使用了模板中未提供的额外数据结构、辅助函数，请提供简短的理由。
   - 如果您实现了任何测试用例来测试您的智能合约，请提供测试用例的简短描述。

# 测试方法

1、安装nodejs
https://nodejs.org/

2、安装hardhat
```shell
npm install --save-dev hardhat 或者 yarn add --dev hardhat
```
3、运行测试用例
```shell
npx hardhat test
```

4、其他说明
- 测试用例：test/basic_contract_test.js
- 合约文件：contracts/CarPooling.sol
- 合约和测试用例有中文描述，请酌情修改，另外合约注释很清晰方便你理解，但提交给学校的时候建议稍微删减